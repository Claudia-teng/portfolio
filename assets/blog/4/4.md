# JavaScript Closureæ˜¯è¨˜æ†¶çš„å°ç›’å­ï¼

###### 2022/04/02

é€™ç¯‡è¦ä¾†ä»‹ç´¹çš„æ˜¯JavaScriptçš„Closureï¼ˆé–‰åŒ…ï¼‰ï¼ŒClosureç®—æ˜¯æ¯”è¼ƒé€²éšçš„æ¦‚å¿µï¼Œå¸Œæœ›ä½ æ˜¯å·²ç¶“ç­è§£JavaScriptçš„function first class citizenä»¥åŠlexical scopeçš„æ¦‚å¿µï¼Œå†è®€é€™ç¯‡æœƒæ¯”è¼ƒå¥½æ‡‚ï½

### \# What is closure

åœ¨functionè£¡é¢çš„local scopeç•¶ä¸­ï¼Œå¦‚æœæœ‰ä¸€å€‹aè®Šæ•¸ï¼Œé‚£éº¼åœ¨åŸ·è¡Œå®Œé€™å€‹functionä¹‹å¾Œï¼Œé€™å€‹aè®Šæ•¸æ‡‰è©²å°±æœƒæ¶ˆå¤±åœ¨è¨˜æ†¶é«”ç•¶ä¸­ã€‚

```javascript
function example() {
  let a = 100;
  console.log(a);
}

example(); //100
```

é‚£æˆ‘å€‘æ¥è‘—ä¾†çœ‹é€™å€‹ä¾‹å­ï¼š

```javascript
function a() {
  let grandpa = 'grandpa';
  return function b() {
    let father = 'father';
    return function c() {
        let son = 'son';
        return `${grandpa} > ${father} > ${son}`
    }
  }
}

a(); //Function: b
a()(); // Function: c
a()()(); // 'grandpa > father > son'
```
çœ‹åˆ°```a()()()```çš„çµæœï¼Œä½ æœƒè¦ºå¾—å¾ˆæ­£å¸¸ï¼Œé‚„æ˜¯å¾ˆå¥‡æ€ªï¼Ÿ

ç…§ç†ä¾†èªªåŸ·è¡Œå®Œ```a()```ä¹‹å¾Œï¼Œ```let grandpa = 'grandpa'```é€™ä¸€è¡Œä¸æ˜¯æ‡‰è©²åœ¨åŸ·è¡Œå®Œç•¢ä»¥å¾Œï¼Œæ¶ˆå¤±åœ¨è¨˜æ†¶é«”äº†å—ï¼Ÿç‚ºä»€éº¼åŸ·è¡Œåˆ°```c()```çš„æ™‚å€™ï¼Œä»–é‚„æœƒè¨˜å¾—ï¼Ÿ

é€™è£¡å°±æ˜¯Closureçš„ç¤ºç¯„ï¼Œå› ç‚ºJavaScriptç™¼ç¾åœ¨```c()```è£¡é¢ï¼Œé‚„æœ‰ç”¨åˆ°```grandpa```é€™å€‹è®Šæ•¸ï¼Œæ‰€ä»¥æŠŠ```grandpa```æ”¾åœ¨è¨˜æ†¶çš„å°ç›’å­è£¡é¢ï¼Œç­‰åˆ°åŸ·è¡Œ```c()```çš„æ™‚å€™ï¼Œå°±é‚„æ‰¾å¾—åˆ°é€™å€‹è®Šæ•¸ã€‚

æˆ‘å€‘å†ä¾†çœ‹ç¬¬äºŒå€‹ä¾‹å­ï¼š

```javascript
function callMeMaybe() {
  const callMe = 'Hi!';
  setTimeout(function() {
      console.log(callMe);
  }, 4000);
}

callMeMaybe(); // Hi!
```

JavaScriptåœ¨å››ç§’ä¹‹å¾Œ```console.log```ï¼Œé‚„æ˜¯èªå¾—```callMe```é€™å€‹è®Šæ•¸ï¼Œè€Œä¸æ˜¯åœ¨åŸ·è¡Œå®Œ```callMeMaybe()```å¾Œï¼Œ```callMe```å°±å¾æ­¤æ¶ˆå¤±ï¼Œç‚ºä»€éº¼ï¼Ÿ

å› ç‚ºJavaScriptçŸ¥é“ï¼Œå™¢ï¼é€™è£¡æœ‰å€‹functionæœ‰ç”¨åˆ°```callMe```ï¼Œæ‰€ä»¥å³ä¾¿```setTimeout```è¢«ä¸Ÿåˆ°Web APIçš„æ™‚å€™ï¼ŒJavaScripté‚„æ˜¯è¨˜å¾—ä¿å­˜```callMe```ã€‚

å› æ­¤ï¼ŒClosureå°±æ˜¯ç•¶é€™å€‹functionåœ¨å¤–éƒ¨ï¼ˆè„«é›¢äº†lexical scopeï¼‰è¢«åŸ·è¡Œçš„æ™‚å€™ï¼Œä»–ä»ç„¶æœƒè¨˜å¾—åŸæœ¬çš„lexical scopeæ˜¯ä»€éº¼ã€‚

é‚£ä½ å¯èƒ½æœƒå•èªªï¼Œç‚ºä»€éº¼è¦æœ‰Closureé€™å€‹ç‰¹æ€§ï¼Ÿä»–å¯ä»¥ç”¨åœ¨å“ªï¼Ÿ

æ¥ä¸‹ä¾†å°±è¦ç¹¼çºŒä»‹ç´¹Closureå¯¦ç”¨çš„å…©å€‹ç‹€æ³ã€‚

### \# Memory efficient

æˆ‘å€‘å‡è¨­æœ‰ä¸€å€‹functionï¼Œè£¡é¢éœ€è¦å®£å‘Šä¸€å€‹å¾ˆå¤§çš„arrayã€‚

```javascript
function heavyDuty(item) {
  const bigArray = new Array(7000).fill('ğŸ˜„')
  console.log('created!');
  return bigArray[item]
}

heavyDuty(699) // 'created!'
heavyDuty(699) // 'created!'
heavyDuty(699) // 'created!'
```

è¦å–å¾—é€™å€‹arrayè£¡é¢çš„å€¼ï¼Œä»–å°±åŸ·è¡Œäº†ä¸‰æ¬¡functionï¼Œä¹Ÿå®£å‘Šäº†ä¸‰æ¬¡é€™å€‹å·¨å¤§çš„arrayã€‚

é‚£æœ‰ä»€éº¼è¾¦æ³•ï¼Œå¯ä»¥è®“é€™å€‹arrayé‚„æ˜¯å­˜åœ¨åœ¨functionè£¡é¢çš„ç‹€æ³ä¸‹ï¼Œæˆ‘æ¯æ¬¡æƒ³è¦å–å¾—è£¡é¢çš„å€¼çš„æ™‚å€™ï¼Œä¸éœ€è¦å†è®“ä»–é‡è¤‡å®£å‘Šå¾ˆå¤šæ¬¡arrayï¼Ÿ

æˆ‘å€‘å¯ä»¥åˆ©ç”¨Closureçš„ç‰¹æ€§æ”¹å¯«çœ‹çœ‹ï¼š

```javascript
function heavyDuty2() {
  const bigArray = new Array(7000).fill('ğŸ˜„')
  console.log('created Again!')
  return function(item) {
    return bigArray[item]
  }
}

const getHeavyDuty = heavyDuty2(); // 'created Again!'
getHeavyDuty(699)
getHeavyDuty(699)
getHeavyDuty(699)
```

ä¸€æ¨£åœ¨functionè£¡é¢å®£å‘Šarrayï¼Œåªæ˜¯é€™æ™‚å€™æˆ‘returnå¦å¤–ä¸€å€‹functionï¼Œä¸¦å°‡æ­¤functionè³¦äºˆçµ¦```getHeavyDuty```é€™å€‹è®Šæ•¸ã€‚

ä¹‹å¾Œæˆ‘æƒ³è¦å–å€¼ï¼Œå°±ç”¨```getHeavyDuty```å°±å¥½ï¼Œä¸éœ€è¦é‡æ–°å‘¼å«```heavyDuty2```ï¼Œé€ æˆå¤šæ¬¡å®£å‘Šarrayçš„çµæœã€‚

### \# Encapsulation

Closureé‚„æœ‰å¦å¤–ä¸€å€‹ä½¿ç”¨æ–¹å¼ï¼Œå°±æ˜¯èƒ½ä¿è­·local scopeè£¡é¢çš„è®Šæ•¸ï¼Œä¸è®“global scopeèƒ½å–å¾—ã€‚

æˆ‘å€‘ä¾†çœ‹é€™å€‹ä¾‹å­ï¼š

```javascript
const makeNuclearButton = () => {
  let timeWithoutDestruction = 0;
  const passTime = () => timeWithoutDestruction++;
  const totalPeaceTime = () => timeWithoutDestruction;
  const launch = () => {
    timeWithoutDestruction = -1;
    return 'ğŸ’¥';
  }

  setInterval(passTime, 1000);
  return {
    launch: launch,
    totalPeaceTime: totalPeaceTime
  }
}
```

æ¥è‘—æˆ‘å€‘å°‡```makeNuclearButton()```è³¦äºˆåˆ°```ohno```é€™å€‹è®Šæ•¸ã€‚

```javascript
const ohno = makeNuclearButton();
// 1ç§’å¾Œ
ohno.totalPeaceTime(); // 1
// 10ç§’å¾Œ
ohno.totalPeaceTime(); // 10
ohno.launch; //  'ğŸ’¥'
```

çˆ†ç‚¸äº†ï¼å› ç‚ºreturnä¸­æœ‰```launch```çš„é—œä¿‚ï¼Œè®“æˆ‘å€‘å¯ä»¥å¾å¤–é¢å¼•çˆ†ã€‚

å¦‚æœæŠŠ```launch```å¾returnç§»é™¤ï¼Œé‚£éº½æˆ‘å€‘å°±ç„¡æ³•é€é```ohno```å»åŸ·è¡Œä»–ã€‚

```javascript
const makeNuclearButton = () => {
  let timeWithoutDestruction = 0;
  const passTime = () => timeWithoutDestruction++;
  const totalPeaceTime = () => timeWithoutDestruction;
  const launch = () => {
    timeWithoutDestruction = -1;
    return 'ğŸ’¥';
  }

  setInterval(passTime, 1000);
  return { totalPeaceTime: totalPeaceTime }
}

ohno.launch; // Uncaught ReferenceError: ohno is not defined
```

ç”±æ­¤å¯ä»¥çœ‹å‡ºï¼ŒClousureå¯ä»¥è—‰ç”±returnä¾†æ±ºå®šå¤–éƒ¨å¯ä»¥å–å¾—å’ŒåŸ·è¡Œé€™å€‹functionçš„å“ªäº›æ±è¥¿ï¼Œåƒ```launch```å°±èƒ½å› æ­¤è¢«ä¿è­·ä½ã€‚

è³‡æ–™ä¾†æºï¼š
[Udemy | JavaScript: The Advanced Concepts](https://www.udemy.com/course/advanced-javascript-concepts/)


